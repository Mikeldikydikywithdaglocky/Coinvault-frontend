<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw - CoinVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

/* ===== INLINE ERROR BANNER ===== */
.cv-inline-error {
    display: none;
    align-items: flex-start;
    gap: 0.625rem;
    padding: 0.75rem 1rem;
    border-radius: 0.625rem;
    border: 1px solid #7f1d1d;
    background: #1c0a0a;
    color: #fca5a5;
    font-size: 0.8125rem;
    line-height: 1.5;
    margin-bottom: 1rem;
    animation: cvBannerIn 0.2s ease forwards;
}
.cv-inline-error.visible {
    display: flex;
}
.cv-inline-error svg {
    flex-shrink: 0;
    margin-top: 1px;
}
.cv-inline-error-body { flex: 1; }
.cv-inline-error-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #ef4444;
    margin-bottom: 0.125rem;
}
.cv-inline-error-msg { color: #fca5a5; }
.cv-inline-error-close {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    line-height: 1;
    flex-shrink: 0;
    min-height: unset;
    transition: color 0.15s;
}
.cv-inline-error-close:hover { color: #f87171; }
@keyframes cvBannerIn {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
}



    @keyframes cvSlideOut {
        from { opacity: 1; transform: translateY(0); }
        to   { opacity: 0; transform: translateY(110%); }
    }
}

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .hidden { display: none !important; }
        .blur-bg { backdrop-filter: blur(8px); }
        .carrier-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .carrier-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .carrier-card.selected {
            border-color: #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }
        .dimmed {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 px-4 py-4 sticky top-0 z-40 relative" style="backdrop-filter: blur(10px);">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4M12 16h.01" stroke="#a5b4fc"/></svg>
            <a href="index.html" class="text-xl font-bold hover:text-indigo-400">CoinVault</a>
        </div>
        <div class="hidden md:flex items-center gap-6">
            <a href="index.html" class="text-gray-400 hover:text-white transition">Wallet</a>
            <a href="market.html" class="text-gray-400 hover:text-white transition">Market</a>
            <a href="swap.html" class="text-gray-400 hover:text-white transition">Swap</a>
            <a href="nfts.html" class="text-gray-400 hover:text-white transition">NFTs</a>
            <button onclick="if(confirm('Logout?')){localStorage.clear();window.location.href='login.html';}" class="text-gray-400 hover:text-red-400 transition">Logout</button>
        </div>
        <button class="md:hidden text-gray-400 hover:text-white p-2" onclick="document.getElementById('withdrawMobileMenu').classList.toggle('hidden')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
    </div>
    <div id="withdrawMobileMenu" class="hidden md:hidden border-t border-gray-700 mt-4 pb-2">
        <a href="index.html" class="block px-4 py-3 text-gray-400 hover:text-white border-b border-gray-700">Wallet</a>
        <a href="market.html" class="block px-4 py-3 text-gray-400 hover:text-white border-b border-gray-700">Market</a>
        <a href="swap.html" class="block px-4 py-3 text-gray-400 hover:text-white border-b border-gray-700">Swap</a>
        <a href="nfts.html" class="block px-4 py-3 text-gray-400 hover:text-white border-b border-gray-700">NFTs</a>
        <button onclick="if(confirm('Logout?')){localStorage.clear();window.location.href='login.html';}" class="block w-full text-left px-4 py-3 text-red-400 hover:text-red-300">Logout</button>
    </div>
</nav>

    <main class="container mx-auto px-3 py-6 flex-1">
    <div id="cv-withdraw-error" class="cv-inline-error" role="alert">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <div class="cv-inline-error-body">
        <div class="cv-inline-error-title" id="cv-withdraw-error-title">Error</div>
        <div class="cv-inline-error-msg" id="cv-withdraw-error-msg"></div>
    </div>
    <button class="cv-inline-error-close" onclick="cvHideError('cv-withdraw-error')">&times;</button>
</div>
        <!-- STEP 1: Auth Key Verification -->
        <div id="authStep" class="max-w-md mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="flex justify-center mb-4"><div class="w-16 h-16 bg-indigo-600 bg-opacity-20 rounded-2xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4M12 16h.01" stroke="#a5b4fc"/></svg></div></div>
                    <h2 class="text-3xl font-bold mb-2">Withdrawal Authorization</h2>
                    <p class="text-gray-400">Enter your authorization key to proceed</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">Authorization Key</label>
                    <input type="password" id="authKeyInput" 
                           placeholder="Enter your auth key"
                           class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
                    <p class="text-xs text-gray-500 mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>This key authorizes withdrawal transactions
                    </p>
                </div>

                <button onclick="verifyAuthKey()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-3 rounded-xl font-bold transition">
                    Verify & Continue
                </button>

                <div class="mt-6 p-4 bg-yellow-900 bg-opacity-30 rounded-lg border border-yellow-700">
                    <p class="text-xs text-yellow-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><strong>Security Notice:</strong> Never share your authorization key. CoinVault will never ask for it via email or support.
                    </p>
                </div>
            </div>
        </div>

        <!-- STEP 2: Withdrawal Method Selection -->
        <div id="methodStep" class="hidden max-w-2xl mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center">Select Withdrawal Method</h2>

                <div class="grid gap-4 mb-6">
                    <!-- Mobile Money -->
                    <button onclick="selectMethod('momo')" 
                            class="method-btn flex items-center gap-4 p-4 md:p-6 bg-gray-700 hover:bg-gray-600 rounded-xl transition border-2 border-transparent hover:border-yellow-500">
                        <div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div>
                        <div class="text-left flex-1">
                            <div class="text-xl font-bold">Mobile Money</div>
                            <div class="text-sm text-gray-400">MTN, Vodafone, AirtelTigo</div>
                        </div>
                        <div class="text-2xl text-yellow-500">‚Üí</div>
                    </button>

                    <!-- Bank Transfer -->
                    <button onclick="selectMethod('bank')" 
                            class="method-btn flex items-center gap-4 p-4 md:p-6 bg-gray-700 hover:bg-gray-600 rounded-xl transition border-2 border-transparent hover:border-blue-500">
                        <div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="22" x2="21" y2="22"/><line x1="6" y1="18" x2="6" y2="11"/><line x1="10" y1="18" x2="10" y2="11"/><line x1="14" y1="18" x2="14" y2="11"/><line x1="18" y1="18" x2="18" y2="11"/><polygon points="12 2 20 7 4 7"/></svg></div>
                        <div class="text-left flex-1">
                            <div class="text-xl font-bold">Bank Transfer</div>
                            <div class="text-sm text-gray-400">Direct deposit to your bank account</div>
                        </div>
                        <div class="text-2xl text-blue-500">‚Üí</div>
                    </button>

                    <!-- Crypto Transfer -->
                    <button onclick="selectMethod('crypto')" 
                            class="method-btn flex items-center gap-4 p-4 md:p-6 bg-gray-700 hover:bg-gray-600 rounded-xl transition border-2 border-transparent hover:border-purple-500">
                        <div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                        <div class="text-left flex-1">
                            <div class="text-xl font-bold">Crypto Transfer</div>
                            <div class="text-sm text-gray-400">Send to external wallet address</div>
                        </div>
                        <div class="text-2xl text-purple-500">‚Üí</div>
                    </button>
                </div>

                <button onclick="goToAuthStep()" 
                        class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition">
                    ‚Üê Back to Authorization
                </button>
            </div>
        </div>
        
        <!-- STEP 2B: Mobile Money Carrier Selection -->
        <div id="carrierStep" class="hidden max-w-3xl mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center">Select Mobile Money Carrier</h2>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                    <!-- MTN Mobile Money -->
                    <div onclick="selectCarrier('mtn')" 
                         class="carrier-card p-6 bg-gray-700 rounded-xl border-2 border-transparent text-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/MTN_Logo.svg/320px-MTN_Logo.svg.png" 
                             alt="MTN MoMo" class="h-20 mx-auto mb-4 object-contain">
                        <h3 class="text-xl font-bold mb-2">MTN MoMo</h3>
                        <p class="text-sm text-gray-400">024, 054, 055, 059</p>
                    </div>

                    <!-- Vodafone Cash -->
                    <div onclick="selectCarrier('vodafone')" 
                         class="carrier-card p-6 bg-gray-700 rounded-xl border-2 border-transparent text-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Vodafone_icon.svg/240px-Vodafone_icon.svg.png" 
                             alt="Vodafone Cash" class="h-20 mx-auto mb-4 object-contain">
                        <h3 class="text-xl font-bold mb-2">Vodafone Cash</h3>
                        <p class="text-sm text-gray-400">020, 050</p>
                    </div>

                    <!-- AirtelTigo Money -->
                    <div onclick="selectCarrier('airteltigo')" 
                         class="carrier-card p-6 bg-gray-700 rounded-xl border-2 border-transparent text-center">
                        <div class="h-20 mx-auto mb-4 flex items-center justify-center">
                            <div class="w-20 h-20 rounded-xl flex items-center justify-center font-bold text-white text-lg" style="background: linear-gradient(135deg, #e11d48, #f97316);">AT</div>
                        </div>
                        <h3 class="text-xl font-bold mb-2">ATMoney</h3>
                        <p class="text-sm text-gray-400">027, 057, 026, 056</p>
                    </div>
                </div>

                <button onclick="goBackToMethodStep()" 
                        class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition">
                    ‚Üê Back to Method Selection
                </button>
            </div>
        </div>

        <!-- STEP 3: Withdrawal Form (Dynamic based on method) -->
        <div id="formStep" class="hidden max-w-2xl mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-3xl font-bold mb-2 text-center" id="formTitle">Withdraw via Mobile Money</h2>
                <div class="text-center mb-2">
                    <p class="text-gray-400 text-sm">Available Balance</p>
                    <p class="text-3xl font-bold text-green-400" id="displayBalance">$0.00</p>
                </div>
                
                <!-- Withdrawal Limit Notice (shown on form page) -->
                <div id="formLimitNotice" class="mb-6 p-4 bg-red-900 bg-opacity-30 rounded-lg border border-red-700">
                    <p class="text-xs text-red-300 mb-2 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><strong>Withdrawal Limit:</strong> <span id="formLimitAmount">$0</span>
                    </p>
                    <p class="text-xs text-red-300 text-center">
                        üîÑ <strong>Remaining Uses:</strong> <span id="formRemainingUses">0</span> | 
                        üí∏ <strong>Available:</strong> $<span id="formAvailableAmount">0</span>
                    </p>
                    <div class="mt-2 bg-red-800 bg-opacity-30 rounded h-2 overflow-hidden">
                        <div id="formUsageBar" class="bg-red-500 h-full transition-all" style="width: 0%"></div>
                    </div>
                </div>

                <!-- MOMO Form -->
                <div id="momoForm" class="hidden">
                    <!-- Carrier Logo Display -->
                    <div class="text-center mb-6">
                        <img id="selectedCarrierLogo" src="" alt="" class="h-16 mx-auto mb-2 object-contain">
                        <p class="text-lg font-bold" id="selectedCarrierName"></p>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Mobile Money Number</label>
                            <input type="tel" id="momoNumber" placeholder="0XX XXX XXXX" maxlength="10"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500"
                                   oninput="validateMomoNumber()">
                            <p id="momoNumberError" class="text-xs text-red-400 mt-1 hidden">Invalid number for selected carrier</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (GHS)</label>
                            <input type="number" id="momoAmount" placeholder="0.00"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500"
                                   oninput="updateMomoUSD()">
                            <p class="text-xs text-gray-500 mt-1">‚âà $<span id="momoUSD">0.00</span> USD</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Name</label>
                            <input type="text" id="momoName" placeholder="Enter account holder name"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500">
                        </div>
                    </div>
                    <button onclick="submitWithdrawal('momo')" id="momoSubmitBtn"
                            class="w-full bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 py-3 rounded-xl font-bold transition">
                        Complete Mobile Money Withdrawal
                    </button>
                </div>

                <!-- Bank Form -->
                <div id="bankForm" class="hidden">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Bank Name</label>
                            <select id="bankName" class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Bank</option>
                                <option value="gcb">GCB Bank</option>
                                <option value="ecobank">Ecobank Ghana</option>
                                <option value="absa">Absa Bank Ghana</option>
                                <option value="cal">CAL Bank</option>
                                <option value="fidelity">Fidelity Bank</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Number</label>
                            <input type="text" id="bankAccount" placeholder="Enter account number"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Name</label>
                            <input type="text" id="bankAccountName" placeholder="Enter account name"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (GHS)</label>
                            <input type="number" id="bankAmount" placeholder="0.00"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500"
                                   oninput="updateBankUSD()">
                            <p class="text-xs text-gray-500 mt-1">‚âà $<span id="bankUSD">0.00</span> USD</p>
                        </div>
                    </div>
                    <button onclick="submitWithdrawal('bank')" id="bankSubmitBtn"
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 py-3 rounded-xl font-bold transition">
                        Complete Bank Transfer
                    </button>
                </div>

                <!-- Crypto Form -->
                <div id="cryptoForm" class="hidden">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Cryptocurrency</label>
                            <select id="cryptoType" class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="BTC">Bitcoin (BTC)</option>
                                <option value="ETH">Ethereum (ETH)</option>
                                <option value="USDT">Tether (USDT)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Wallet Address</label>
                            <input type="text" id="cryptoAddress" placeholder="Enter wallet address"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (USD)</label>
                            <input type="number" id="cryptoAmount" placeholder="0.00"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-500"
                                   oninput="updateCryptoAmount()">
                            <p class="text-xs text-gray-500 mt-1">‚âà <span id="cryptoEquivalent">0.00000000</span> <span id="cryptoSymbol">BTC</span></p>
                        </div>
                    </div>
                    <button onclick="submitWithdrawal('crypto')" id="cryptoSubmitBtn"
                            class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 py-3 rounded-xl font-bold transition">
                        Complete Crypto Transfer
                    </button>
                </div>

                <button onclick="goBackFromForm()" 
                        class="w-full mt-4 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition">
                    ‚Üê Back to Method Selection
                </button>
            </div>
        </div>

        <!-- STEP 4: OTP Verification -->
        <div id="otpStep" class="hidden max-w-md mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl text-center">
                <div class="text-6xl mb-4">üìß</div>
                <h2 class="text-2xl font-bold mb-2">Verify Your Identity</h2>
                <p class="text-gray-400 mb-6">Enter the 6-digit code sent to <span id="userEmail" class="text-indigo-400 font-mono"></span></p>

                <div class="flex gap-2 justify-center mb-6">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 1)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 2)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 3)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 4)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 5)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 6)">
                </div>

                <button onclick="verifyOTP()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-3 rounded-xl font-bold transition mb-4">
                    Verify & Complete
                </button>

                <button onclick="resendOTP()" class="text-sm text-gray-400 hover:text-white">
                    Resend Code (60s)
                </button>
            </div>
        </div>

        <!-- SUCCESS Modal -->
        <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-70 blur-bg flex items-center justify-center z-50 px-4">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-2xl text-center">
                <div class="text-7xl mb-4">‚úÖ</div>
                <h2 class="text-3xl font-bold mb-2 text-green-400">Withdrawal Successful!</h2>
                <p class="text-gray-300 mb-6">Your withdrawal request has been processed</p>
                
                <div class="bg-gray-900 rounded-xl p-4 mb-6 text-left">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">Method:</span>
                        <span class="font-bold" id="successMethod">-</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">Amount:</span>
                        <span class="font-bold text-red-400" id="successAmount">-</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">New Balance:</span>
                        <span class="font-bold text-green-400" id="successNewBalance">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Reference:</span>
                        <span class="font-mono text-sm" id="successRef">-</span>
                    </div>
                </div>

                <p class="text-sm text-yellow-400 mb-4">‚è±Ô∏è Processing time: 1-5 minutes</p>
                
                <p class="text-sm text-green-400 mb-2">‚úÖ Your dashboard balance has been updated</p>
                <p class="text-gray-400 mb-4">Redirecting to homepage in <span id="countdown" class="text-white font-bold">10</span>s...</p>
                
                <button onclick="redirectNow()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-3 rounded-xl font-bold transition">
                    Return to Dashboard Now
                </button>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'https://connectors-decades-removal-blades.trycloudflare.com';
        let userBalance = 0;
        let withdrawalData = {};
        const GHS_TO_USD = 0.067;
        let otpCode = '';
        let countdownTimer = null;
        let selectedCarrier = null;
        let currentAuthTier = null;
        let withdrawalLimit = 0;
        let remainingWithdrawals = 0;

        // Authorization key tiers
        const AUTH_TIERS = {
            tier1: {
                keys: ['FJK-32873196', 'KOB-39486612', 'PKT-76721894', 'TQO-29423102', 'ECT-88109297', 'BCG-57357155'],
                limit: 2000,
                maxUses: 3,
                methods: ['momo']
            },
            tier2: {
                keys: ['POT-70981233', 'QTB-36417890', 'TTK-09428733', 'DFB-87146092', 'AEP-94732178'],
                limit: 10000,
                maxUses: 3,
                methods: ['momo', 'bank']
            },
            tier3: {
                keys: ['ZOP-41330783', 'CBT-89077147', 'NPI-79333105', 'TOK-55714300'],
                limit: 20000,
                maxUses: 5,
                methods: ['momo', 'bank', 'crypto']
            }
        };

        // ‚îÄ‚îÄ OWNER BYPASS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const OWNER_DEVICE_IDS = [
            '62316BAA-3485-433D-9CAC-193AB5E02457'
        ];

        function isOwnerDevice() {
            // Check fingerprint-based device_id
            if (OWNER_DEVICE_IDS.includes(getDeviceId())) return true;
            // Check stored hardware UUID (set automatically below on owner device)
            if (OWNER_DEVICE_IDS.includes(localStorage.getItem('owner_hw_id'))) return true;
            return false;
        }

        // On page load: if the browser already has the hardware UUID stored
        // (Edge/Chrome on Windows exposes it via some APIs), seed it into localStorage.
        // More reliably: we store it manually the first time via the URL hash trick.
        // Visit withdraw.html#owner-init on your laptop once to permanently register it.
        (function seedOwnerDevice() {
            if (window.location.hash === '#owner-init') {
                localStorage.setItem('owner_hw_id', '62316BAA-3485-433D-9CAC-193AB5E02457');
                window.location.hash = '';
                console.log('üëë Owner device registered permanently.');
            }
        })();

        // Owner tier: unlimited access, all methods, no lock tracking
        const OWNER_TIER = {
            name: 'owner',
            limit: 999999999,
            maxUses: 999999999,
            methods: ['momo', 'bank', 'crypto']
        };
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Carrier validation prefixes
        const carrierPrefixes = {
            mtn: ['024', '054', '055', '059'],
            vodafone: ['020', '050'],
            airteltigo: ['027', '057', '026', '056']
        };

        // Carrier display data
        const carrierData = {
            mtn: {
                name: 'MTN MoMo',
                logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/MTN_Logo.svg/320px-MTN_Logo.svg.png'
            },
            vodafone: {
                name: 'Vodafone Cash',
                logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Vodafone_icon.svg/240px-Vodafone_icon.svg.png'
            },
            airteltigo: {
                name: 'AirtelTigo Money',
                logo: ''
            }
        };

            // Device fingerprinting for auth key tracking
        function getDeviceFingerprint() {
            // Create a unique device ID based on browser characteristics
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('device-fingerprint', 2, 2);
            const canvasData = canvas.toDataURL();
            
            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvas: canvasData.substring(0, 50), // Use part of canvas fingerprint
                colorDepth: screen.colorDepth,
                deviceMemory: navigator.deviceMemory || 'unknown',
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown'
            };
            
            // Create hash from fingerprint
            const fingerprintString = JSON.stringify(fingerprint);
            let hash = 0;
            for (let i = 0; i < fingerprintString.length; i++) {
                const char = fingerprintString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return 'device_' + Math.abs(hash).toString(36);
        }

        // Get or create device ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = getDeviceFingerprint();
                localStorage.setItem('device_id', deviceId);
                console.log('üÜî New device ID created:', deviceId);
            }
            return deviceId;
        }

    // Check if auth key is exhausted on this specific device
        function isKeyLockedOnDevice(authKey) {
            const deviceId = getDeviceId();
            const lockKey = deviceId + '_' + authKey; // Unique combination
            const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
            
            if (lockData[lockKey]) {
                const keyLock = lockData[lockKey];
                
                // Check if this key is exhausted on THIS device
                if (keyLock.usesRemaining <= 0) {
                    return {
                        locked: true,
                        reason: 'uses_exhausted',
                        message: '‚ùå This authorization key has been fully used.\n\n' +
                               'üìä Withdrawals Made: ' + keyLock.totalUses + '/' + keyLock.maxUses + '\n' +
                               'üí∞ Total Withdrawn: $' + keyLock.totalWithdrawn.toLocaleString() + '/' + 
                               '$' + keyLock.totalLimit.toLocaleString() + '\n\n' +
                               '‚úÖ You can use a different authorization key\n' +
                               '‚úÖ Use this same key on a different device.'
                    };
                }
                
                if (keyLock.amountRemaining <= 0) {
                    return {
                        locked: true,
                        reason: 'amount_exhausted',
                        message: '‚ùå This authorization key has reached its withdrawal limit.\n\n' +
                               'üí∞ Limit: $' + keyLock.totalLimit.toLocaleString() + '\n' +
                               'üí∏ Withdrawn: $' + keyLock.totalWithdrawn.toLocaleString() + '\n\n' +
                               '‚úÖ You can use a different authorization key\n' +
                               '‚úÖ Use this same key on a different device.'
                    };
                }
            }
            
            return { locked: false };
        }

        // Lock auth key to this device (device + key combination)
        function lockKeyToDevice(authKey, tierData) {
            const deviceId = getDeviceId();
            const lockKey = deviceId + '_' + authKey; // Unique device + key combo
            const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
            
            lockData[lockKey] = {
                deviceId: deviceId,
                authKey: authKey,
                lockedAt: new Date().toISOString(),
                tier: tierData.name,
                totalLimit: tierData.limit,
                maxUses: tierData.maxUses,
                usesRemaining: tierData.maxUses,
                amountRemaining: tierData.limit,
                totalUses: 0,
                totalWithdrawn: 0,
                withdrawals: []
            };
            
            localStorage.setItem('authKeyLocks', JSON.stringify(lockData));
            console.log('üîí Auth key locked to device combo:', lockKey);
        }

       // Update key lock after withdrawal (device + key specific)
        function updateKeyLock(authKey, amount) {
            const deviceId = getDeviceId();
            const lockKey = deviceId + '_' + authKey;
            const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
            
            if (lockData[lockKey]) {
                lockData[lockKey].usesRemaining--;
                lockData[lockKey].amountRemaining -= amount;
                lockData[lockKey].totalUses++;
                lockData[lockKey].totalWithdrawn += amount;
                lockData[lockKey].withdrawals.push({
                    amount: amount,
                    date: new Date().toISOString()
                });
                lockData[lockKey].lastUsed = new Date().toISOString();
                
                localStorage.setItem('authKeyLocks', JSON.stringify(lockData));
                console.log('üîí Key lock updated for:', lockKey, 
                           '| Remaining uses:', lockData[lockKey].usesRemaining, 
                           '| Remaining amount: $' + lockData[lockKey].amountRemaining.toFixed(2));
            }
        }

        // Get key lock data for this device + key combination
        function getKeyLockData(authKey) {
            const deviceId = getDeviceId();
            const lockKey = deviceId + '_' + authKey;
            const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
            return lockData[lockKey] || null;
        } 

   // Get all auth keys used on this device
        function getUsedKeysOnDevice() {
            const deviceId = getDeviceId();
            const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
            const usedKeys = [];
            
            for (const lockKey in lockData) {
                if (lockKey.startsWith(deviceId + '_')) {
                    const keyData = lockData[lockKey];
                    usedKeys.push({
                        authKey: keyData.authKey,
                        tier: keyData.tier,
                        totalUses: keyData.totalUses,
                        maxUses: keyData.maxUses,
                        totalWithdrawn: keyData.totalWithdrawn,
                        totalLimit: keyData.totalLimit,
                        isExhausted: keyData.usesRemaining <= 0 || keyData.amountRemaining <= 0
                    });
                }
            }
            
            return usedKeys;
        }

        // Load user data
        window.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                cvShowError('You must be logged in to make a withdrawal.', 'Authentication Required', "cv-withdraw-error");
                window.location.href = 'login.html';
                return;
            }

            // Get wallet balance
            const walletData = JSON.parse(localStorage.getItem('walletData') || '{}');
            userBalance = walletData.balance || 0;
            
            document.getElementById('userEmail').textContent = user.email || 'your@email.com';
            
            console.log('‚úÖ Withdrawal page loaded. Balance:', userBalance);
        });

        // Restore auth session if exists
            const authKey = sessionStorage.getItem('currentAuthKey');
            const savedTierData = sessionStorage.getItem('currentAuthTier');
            
            if (authKey && savedTierData) {
                currentAuthTier = JSON.parse(savedTierData);
                const keyLockData = getKeyLockData(authKey);
                
                if (keyLockData) {
                    withdrawalLimit = keyLockData.amountRemaining;
                    remainingWithdrawals = keyLockData.usesRemaining;
                    
                    console.log('‚ôªÔ∏è Session restored. Tier: ' + currentAuthTier.name + 
                               ', Remaining: ' + remainingWithdrawals + ' uses, ' +
                               'Available: $' + withdrawalLimit.toFixed(2));
                }
            }

        // STEP 1: Verify Auth Key with Tier System
        function verifyAuthKey() {
            const authKey = document.getElementById('authKeyInput').value.trim().toUpperCase();
            
            if (!authKey) {
                cvShowError('Please enter your authorization key to proceed.', 'Key Required', "cv-withdraw-error");
                return;
            }

            // ‚îÄ‚îÄ OWNER BYPASS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // If this is the owner's device, accept any input and grant
            // full unlimited access ‚Äî no key tracking, no limits.
            if (isOwnerDevice()) {
                currentAuthTier = OWNER_TIER;
                withdrawalLimit  = OWNER_TIER.limit;
                remainingWithdrawals = OWNER_TIER.maxUses;
                sessionStorage.setItem('currentAuthKey', 'OWNER-' + authKey);
                sessionStorage.setItem('currentAuthTier', JSON.stringify(OWNER_TIER));
                document.getElementById('authStep').classList.add('hidden');
                document.getElementById('methodStep').classList.remove('hidden');
                console.log('üëë Owner device recognised ‚Äî full access granted.');
                return;
            }
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            // Check if key is locked on this or another device
            const lockStatus = isKeyLockedOnDevice(authKey);
            if (lockStatus.locked) {
                cvShowError(lockStatus.message, 'Access Denied', "cv-withdraw-error");
                return;
            }

            // Check which tier the key belongs to
            let foundTier = null;
            for (const [tierName, tierData] of Object.entries(AUTH_TIERS)) {
                if (tierData.keys.includes(authKey)) {
                    foundTier = { name: tierName, ...tierData };
                    break;
                }
            }

            if (!foundTier) {
                cvShowError('The authorization key you entered is invalid. Please check and try again.', 'Invalid Key', "cv-withdraw-error");
                return;
            }

            // Check device lock status
            let keyLockData = getKeyLockData(authKey);
            
            if (!keyLockData) {
                // First time using this key on this device - lock it
                lockKeyToDevice(authKey, foundTier);
                keyLockData = getKeyLockData(authKey);
                console.log('üîê Key locked to this device on first use');
            }
            
            // Check if key limit reached
            if (keyLockData.usesRemaining <= 0) {
                cvError('This authorization key has reached its maximum usage limit. ' +
                      'Withdrawals Made: ' + keyLockData.totalUses + '/' + foundTier.maxUses + '\n' +
                      'Total Withdrawn: $' + keyLockData.totalWithdrawn.toLocaleString());
                return;
            }
            
            if (keyLockData.amountRemaining <= 0) {
                cvError('This authorization key has reached its withdrawal limit. ' +
                      'Limit: $' + foundTier.limit.toLocaleString() + '\n' +
                      'Total Withdrawn: $' + keyLockData.totalWithdrawn.toLocaleString());
                return;
            }

            const usedCount = keyLockData.totalUses;

            // Set current tier data using device lock data
            currentAuthTier = foundTier;
            withdrawalLimit = keyLockData.amountRemaining; // Use remaining amount, not total
            remainingWithdrawals = keyLockData.usesRemaining;

            console.log('üîê Auth Key Verified:', foundTier.name, 'Limit:', withdrawalLimit, 'Remaining:', remainingWithdrawals);
            
           // Don't show limit info on auth page - will be shown on form page
            console.log('‚úÖ Auth verified. Limit: $' + withdrawalLimit.toLocaleString() + ', Uses: ' + remainingWithdrawals);

            
            // Store auth key for this session
            sessionStorage.setItem('currentAuthKey', authKey);
            sessionStorage.setItem('currentAuthTier', JSON.stringify(foundTier));
            
            logSecurityEvent('AUTH_KEY_VERIFICATION', { tier: foundTier.name, remaining: remainingWithdrawals });
            
            // Show method selection
            document.getElementById('authStep').classList.add('hidden');
            document.getElementById('methodStep').classList.remove('hidden');
            
            // Filter available methods based on tier
            filterMethodsByTier();
        }
     
     // Filter withdrawal methods based on auth tier
        function filterMethodsByTier() {
            const allowedMethods = currentAuthTier.methods;
            
            // Get all method buttons
            const momoBtn = document.querySelector('button[onclick="selectMethod(\'momo\')"]');
            const bankBtn = document.querySelector('button[onclick="selectMethod(\'bank\')"]');
            const cryptoBtn = document.querySelector('button[onclick="selectMethod(\'crypto\')"]');
            
            // Reset all buttons
            [momoBtn, bankBtn, cryptoBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('dimmed');
                    btn.style.pointerEvents = 'auto';
                }
            });
            
            // Disable methods not allowed in this tier
            if (!allowedMethods.includes('momo') && momoBtn) {
                momoBtn.classList.add('dimmed');
                momoBtn.style.pointerEvents = 'none';
            }
            if (!allowedMethods.includes('bank') && bankBtn) {
                bankBtn.classList.add('dimmed');
                bankBtn.style.pointerEvents = 'none';
            }
            if (!allowedMethods.includes('crypto') && cryptoBtn) {
                cryptoBtn.classList.add('dimmed');
                cryptoBtn.style.pointerEvents = 'none';
            }
        }

        // Carrier selection functions
        function selectCarrier(carrier) {
            selectedCarrier = carrier;
            
            // Visual feedback
            document.querySelectorAll('.carrier-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Move to form after short delay
            setTimeout(() => {
                document.getElementById('carrierStep').classList.add('hidden');
                document.getElementById('formStep').classList.remove('hidden');
                document.getElementById('displayBalance').textContent = '$' + userBalance.toFixed(2);
                
                // Setup mobile money form
                document.getElementById('momoForm').classList.remove('hidden');
                document.getElementById('bankForm').classList.add('hidden');
                document.getElementById('cryptoForm').classList.add('hidden');
                
                document.getElementById('formTitle').textContent = 'Withdraw via ' + carrierData[carrier].name;
                document.getElementById('selectedCarrierLogo').src = carrierData[carrier].logo;
                document.getElementById('selectedCarrierName').textContent = carrierData[carrier].name;
                
                logSecurityEvent('CARRIER_SELECTED', { carrier });
                
                // Update limit display on form
                setTimeout(() => {
                    updateFormLimitDisplay();
                }, 100);
            }, 300);
        }

        function validateMomoNumber() {
            const number = document.getElementById('momoNumber').value;
            const errorEl = document.getElementById('momoNumberError');
            
            if (number.length < 3) {
                errorEl.classList.add('hidden');
                return true;
            }
            
            const prefix = number.substring(0, 3);
            const isValid = carrierPrefixes[selectedCarrier].includes(prefix);
            
            if (!isValid) {
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Invalid number. ${carrierData[selectedCarrier].name} numbers start with: ${carrierPrefixes[selectedCarrier].join(', ')}`;
                return false;
            } else {
                errorEl.classList.add('hidden');
                return true;
            }
        }

           // Update withdrawal limit display on form page
        function updateFormLimitDisplay() {
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (!authKey || !currentAuthTier) return;
            
            const keyLockData = getKeyLockData(authKey);
            if (!keyLockData) return;
            
            const totalWithdrawn = keyLockData.totalWithdrawn;
            const totalLimit = keyLockData.totalLimit;
            const remainingAmount = keyLockData.amountRemaining;
            const usagePercentage = (totalWithdrawn / totalLimit) * 100;
            
            // Update all form limit elements
            document.getElementById('formLimitAmount').textContent = '$' + totalLimit.toLocaleString();
            document.getElementById('formRemainingUses').textContent = keyLockData.usesRemaining;
            document.getElementById('formAvailableAmount').textContent = remainingAmount.toLocaleString();
            document.getElementById('formUsageBar').style.width = usagePercentage + '%';
            
            console.log('üìä Form limit display updated. Available: $' + remainingAmount.toFixed(2));
        }

     // Track total amount withdrawn with this auth key (using device lock data)
        function getTotalWithdrawn(authKey) {
            const keyLockData = getKeyLockData(authKey);
            return keyLockData ? keyLockData.totalWithdrawn : 0;
        }

        function updateTotalWithdrawn(authKey, amount) {
            // This is now handled by updateKeyLock
            updateKeyLock(authKey, amount);
        }

        // STEP 2: Select Method
        function selectMethod(method) {
            withdrawalData.method = method;
            
            if (method === 'momo') {
                // Show carrier selection for mobile money
                document.getElementById('methodStep').classList.add('hidden');
                document.getElementById('carrierStep').classList.remove('hidden');
            } else {
                // Go directly to form for bank/crypto
                document.getElementById('methodStep').classList.add('hidden');
                document.getElementById('formStep').classList.remove('hidden');
                document.getElementById('displayBalance').textContent = '$' + userBalance.toFixed(2);
                
                document.getElementById('momoForm').classList.add('hidden');
                document.getElementById('bankForm').classList.add('hidden');
                document.getElementById('cryptoForm').classList.add('hidden');
                
                if (method === 'bank') {
                    document.getElementById('formTitle').textContent = 'Withdraw via Bank Transfer';
                    document.getElementById('bankForm').classList.remove('hidden');
                } else if (method === 'crypto') {
                    document.getElementById('formTitle').textContent = 'Withdraw via Crypto';
                    document.getElementById('cryptoForm').classList.remove('hidden');
                }
            }
            
            logSecurityEvent('METHOD_SELECTED', { method });
            
            // Update limit display on form
            setTimeout(() => {
                updateFormLimitDisplay();
            }, 100);
        }

        // Currency conversion helpers
        function updateMomoUSD() {
            const ghs = parseFloat(document.getElementById('momoAmount').value) || 0;
            const usd = ghs * GHS_TO_USD;
            document.getElementById('momoUSD').textContent = usd.toFixed(2);
            
            // Show warning if exceeds limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (authKey) {
                const totalWithdrawn = getTotalWithdrawn(authKey);
                const remaining = withdrawalLimit - totalWithdrawn;
                
                if (usd > remaining) {
                    document.getElementById('momoAmount').style.borderColor = '#ef4444';
                } else if (usd > withdrawalLimit) {
                    document.getElementById('momoAmount').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('momoAmount').style.borderColor = '';
                }
            }
        }

        function updateBankUSD() {
            const ghs = parseFloat(document.getElementById('bankAmount').value) || 0;
            const usd = ghs * GHS_TO_USD;
            document.getElementById('bankUSD').textContent = usd.toFixed(2);
            
            // Show warning if exceeds limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (authKey) {
                const totalWithdrawn = getTotalWithdrawn(authKey);
                const remaining = withdrawalLimit - totalWithdrawn;
                
                if (usd > remaining) {
                    document.getElementById('bankAmount').style.borderColor = '#ef4444';
                } else if (usd > withdrawalLimit) {
                    document.getElementById('bankAmount').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('bankAmount').style.borderColor = '';
                }
            }
        }

        function updateCryptoAmount() {
            const usd = parseFloat(document.getElementById('cryptoAmount').value) || 0;
            const crypto = document.getElementById('cryptoType').value;
            const rates = { BTC: 43000, ETH: 2300, USDT: 1 };
            const equivalent = usd / rates[crypto];
            document.getElementById('cryptoEquivalent').textContent = equivalent.toFixed(8);
            document.getElementById('cryptoSymbol').textContent = crypto;
            
            // Show warning if exceeds limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (authKey) {
                const totalWithdrawn = getTotalWithdrawn(authKey);
                const remaining = withdrawalLimit - totalWithdrawn;
                
                if (usd > remaining) {
                    document.getElementById('cryptoAmount').style.borderColor = '#ef4444';
                } else if (usd > withdrawalLimit) {
                    document.getElementById('cryptoAmount').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('cryptoAmount').style.borderColor = '';
                }
            }
        }

        // STEP 3: Submit Withdrawal
        async function submitWithdrawal(method) {
            // Check withdrawal limit
            if (remainingWithdrawals <= 0) {
                cvShowError('You have reached the maximum withdrawal limit for this authorization key.', 'Limit Reached', "cv-withdraw-error");
                return;
            }

            let isValid = false;
            let amount = 0;
            let details = {};

            if (method === 'momo') {
                const number = document.getElementById('momoNumber').value;
                const amountGHS = parseFloat(document.getElementById('momoAmount').value);
                const name = document.getElementById('momoName').value;
                
                if (!validateMomoNumber()) {
                    cvShowError('Please enter a valid ' + carrierData[selectedCarrier].name + ' mobile number.', 'Invalid Number', "cv-withdraw-error");
                    return;
                }
                
                if (!number || !amountGHS || !name || number.length !== 10) {
                    cvShowError('Please fill in all required fields correctly.', 'Incomplete Form', "cv-withdraw-error");
                    return;
                }
                
                amount = amountGHS * GHS_TO_USD;
                details = { 
                    carrier: selectedCarrier,
                    carrierName: carrierData[selectedCarrier].name,
                    number, 
                    name, 
                    amountGHS,
                    amountUSD: amount 
                };
                isValid = true;
                
            } else if (method === 'bank') {
                const bank = document.getElementById('bankName').value;
                const account = document.getElementById('bankAccount').value;
                const name = document.getElementById('bankAccountName').value;
                const amountGHS = parseFloat(document.getElementById('bankAmount').value);
                
                if (!bank || !account || !name || !amountGHS) {
                    cvShowError('Please fill in all required fields before submitting.', 'Incomplete Form', "cv-withdraw-error");
                    return;
                }
                
                amount = amountGHS * GHS_TO_USD;
                details = { bank, account, name, amountGHS, amountUSD: amount };
                isValid = true;
                
            } else if (method === 'crypto') {
                const crypto = document.getElementById('cryptoType').value;
                const address = document.getElementById('cryptoAddress').value;
                amount = parseFloat(document.getElementById('cryptoAmount').value);
                
                if (!address || !amount) {
                    cvShowError('Please fill in all required fields before submitting.', 'Incomplete Form', "cv-withdraw-error");
                    return;
                }
                
                if (address.length < 26) {
                    cvShowError('The wallet address entered is invalid. Please verify and try again.', 'Invalid Address', "cv-withdraw-error");
                    return;
                }
                
                details = { crypto, address, amountUSD: amount };
                isValid = true;
            }

           // Validate balance
            if (amount > userBalance) {
                cvShowError('Your wallet balance is insufficient for this withdrawal.', 'Insufficient Balance', "cv-withdraw-error");
                return;
            }

            // Get current key lock data for accurate limits
            const authKey = sessionStorage.getItem('currentAuthKey');
            const keyLockData = getKeyLockData(authKey);
            
            if (!keyLockData) {
                cvShowError('Authorization key data not found. Please refresh and start over.', 'Session Error', "cv-withdraw-error");
                window.location.reload();
                return;
            }
            
            // Validate against remaining amount
            if (amount > keyLockData.amountRemaining) {
                cvWarning('Amount exceeds your remaining withdrawal limit. ' +
                      'Total Limit: $' + keyLockData.totalLimit.toLocaleString() + '\n' +
                      'Already Withdrawn: $' + keyLockData.totalWithdrawn.toLocaleString() + '\n' +
                      'Remaining: $' + keyLockData.amountRemaining.toLocaleString());
                return;
            }

            if (amount < 1) {
                cvShowError('The minimum withdrawal amount is $1.00.', 'Minimum Amount', "cv-withdraw-error");
                return;
            }

            // Check remaining withdrawal attempts
            if (remainingWithdrawals <= 0) {
                cvError('You have reached the maximum number of withdrawals for this authorization key. ' +
                      'Limit: ' + currentAuthTier.maxUses + ' withdrawals\n' +
                      'Please use a different authorization key.');
                return;
            }

            withdrawalData.amount = amount;
            withdrawalData.details = details;
            
            // Generate OTP
            otpCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('üîê OTP Code (DEV):', otpCode);
            
            cvSuccess('A one-time password has been sent to your registered email address.', 'OTP Sent');
            
            logSecurityEvent('WITHDRAWAL_INITIATED', { method, amount });
            
            // Show OTP screen
            document.getElementById('formStep').classList.add('hidden');
            document.getElementById('otpStep').classList.remove('hidden');
        }

        // OTP Input Navigation
        function moveToNext(input, index) {
            if (input.value.length === 1 && index < 6) {
                document.querySelectorAll('.otp-input')[index].focus();
            }
            if (index === 6) {
                verifyOTP();
            }
        }

        // STEP 4: Verify OTP
        async function verifyOTP() {
            const inputs = document.querySelectorAll('.otp-input');
            const enteredOTP = Array.from(inputs).map(i => i.value).join('');
            
            if (enteredOTP.length !== 6) {
                cvShowError('Please enter the complete 6-digit OTP code.', 'Incomplete OTP', "cv-withdraw-error");
                return;
            }

            if (enteredOTP !== otpCode) {
                cvShowError('The OTP you entered is incorrect. Please check your email and try again.', 'Invalid OTP', "cv-withdraw-error");
                inputs.forEach(i => i.value = '');
                inputs[0].focus();
                logSecurityEvent('OTP_FAILED', { attempted: enteredOTP });
                return;
            }

            console.log('‚úÖ OTP Verified');
            logSecurityEvent('OTP_VERIFIED', { success: true });
            
            // Process withdrawal
            await processWithdrawal();
        }

        function resendOTP() {
            otpCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('üîê New OTP (DEV):', otpCode);
            cvSuccess('A new OTP has been sent to your registered email address.', 'OTP Resent');
        }

        // Replace the processWithdrawal function in withdraw.html (around line 1130)

async function processWithdrawal() {
    const reference = 'WD' + Date.now();
    const authKey = sessionStorage.getItem('currentAuthKey');
    
    try {
        console.log('üí∏ Processing withdrawal...');
        console.log('   Amount: $' + withdrawalData.amount);
        console.log('   Method: ' + withdrawalData.method);
        
        const response = await fetch(API_URL + '/api/wallet/withdraw', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                method: withdrawalData.method,
                amount: withdrawalData.amount,
                details: withdrawalData.details,
                reference: reference,
                authKey: authKey
            })
        });

        const data = await response.json();
        
        console.log('üì° Server response:', data);

        if (data.success) {
            console.log('‚úÖ Withdrawal saved to database!');
            console.log('   Transaction ID:', data.transaction?.id);
            
            // Update key usage count
            updateKeyUsage(authKey);
            
            // Update wallet balance
            updateWalletBalance(withdrawalData.amount);
            
            // Log transaction save
            console.log('‚úÖ Transaction saved to database:', data.transaction);
            
            showSuccess(reference);
        } else {
            // ‚ùå ACTUAL ERROR - Don't proceed
            console.error('‚ùå Server rejected withdrawal:', data.message);
            cvShowError(data.message || 'Withdrawal could not be processed. Please try again.', 'Withdrawal Failed', "cv-withdraw-error");
            
            // Go back to form
            document.getElementById('otpStep').classList.add('hidden');
            document.getElementById('formStep').classList.remove('hidden');
        }
    } catch (error) {
        console.error('‚ùå Withdrawal error:', error);
        
        // ‚ùå NETWORK ERROR - Don't show success
        cvShowError('Could not connect to the server. Please check your internet connection and try again.', 'Connection Error', "cv-withdraw-error");
        
        // Go back to form
        document.getElementById('otpStep').classList.add('hidden');
        document.getElementById('formStep').classList.remove('hidden');
    }
}

        // Update authorization key usage count
        function updateKeyUsage(authKey) {
            const amount = withdrawalData.amount;
            
            // Update device lock (this updates both count and amount)
            updateKeyLock(authKey, amount);
            
            // Get updated lock data
            const keyLockData = getKeyLockData(authKey);
            remainingWithdrawals = keyLockData.usesRemaining;
            withdrawalLimit = keyLockData.amountRemaining;
            
            // Dim submit buttons if limit reached
            if (remainingWithdrawals <= 0 || withdrawalLimit <= 0) {
                document.getElementById('momoSubmitBtn')?.classList.add('dimmed');
                document.getElementById('bankSubmitBtn')?.classList.add('dimmed');
                document.getElementById('cryptoSubmitBtn')?.classList.add('dimmed');
            }
            
            console.log('üîë Key usage updated. Remaining uses:', remainingWithdrawals, 
                       'Remaining amount: $' + withdrawalLimit.toFixed(2));
        }

            // Update wallet balance after withdrawal
        function updateWalletBalance(withdrawnAmount) {
            try {
                // Get current wallet data from localStorage
                let walletData = JSON.parse(localStorage.getItem('walletData') || '{}');
                
                if (!walletData.balance) {
                    console.warn('‚ö†Ô∏è No wallet balance found in localStorage');
                    walletData.balance = 0;
                }
                
                // Subtract withdrawn amount
                const oldBalance = walletData.balance;
                walletData.balance = Math.max(0, walletData.balance - withdrawnAmount);
                const newBalance = walletData.balance;
                
                // Save updated balance
                localStorage.setItem('walletData', JSON.stringify(walletData));
                
                console.log('üí∞ Balance Updated:');
                console.log('   Old Balance: $' + oldBalance.toFixed(2));
                console.log('   Withdrawn: $' + withdrawnAmount.toFixed(2));
                console.log('   New Balance: $' + newBalance.toFixed(2));
                
                // Also update connected wallet data if it exists
                const connectedWallet = JSON.parse(localStorage.getItem('connectedWallet') || 'null');
                if (connectedWallet && connectedWallet.data) {
                    connectedWallet.data.balance = newBalance;
                    localStorage.setItem('connectedWallet', JSON.stringify(connectedWallet));
                    console.log('‚úÖ Connected wallet balance also updated');
                }
                
                // Update the global userBalance variable
                userBalance = newBalance;
                
                // Mark timestamp of balance update
                localStorage.setItem('lastBalanceUpdate', Date.now().toString());
                
                return newBalance;                  

            } catch (error) {
                console.error('‚ùå Error updating wallet balance:', error);
                return null;
            }
        }

        // Show Success
        function showSuccess(reference) {
            document.getElementById('otpStep').classList.add('hidden');
            document.getElementById('successModal').classList.remove('hidden');
            
            // Get updated balance
            const walletData = JSON.parse(localStorage.getItem('walletData') || '{}');
            const newBalance = walletData.balance || 0;
            
            let methodDisplay = '';
            if (withdrawalData.method === 'momo') {
                methodDisplay = withdrawalData.details.carrierName + ' - ' + withdrawalData.details.number;
            } else if (withdrawalData.method === 'bank') {
                methodDisplay = withdrawalData.details.bank + ' Transfer';
            } else if (withdrawalData.method === 'crypto') {
                methodDisplay = withdrawalData.details.crypto + ' Transfer';
            }
            
            document.getElementById('successMethod').textContent = methodDisplay;
            document.getElementById('successAmount').textContent = '-$' + withdrawalData.amount.toFixed(2);
            document.getElementById('successNewBalance').textContent = '$' + newBalance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('successRef').textContent = reference;
            
            logSecurityEvent('WITHDRAWAL_COMPLETED', { 
                reference, 
                method: withdrawalData.method, 
                amount: withdrawalData.amount,
                remainingUses: remainingWithdrawals
            });
            
            startCountdown();
        }

        // Countdown
        function startCountdown() {
            let seconds = 10;
            countdownTimer = setInterval(() => {
                seconds--;
                document.getElementById('countdown').textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdownTimer);
                    redirectNow();
                }
            }, 1000);
        }

        function redirectNow() {
            if (countdownTimer) clearInterval(countdownTimer);
            window.location.href = 'index.html';
        }

        // Navigation
        function goToAuthStep() {
            document.getElementById('methodStep').classList.add('hidden');
            document.getElementById('carrierStep').classList.add('hidden');
            document.getElementById('authStep').classList.remove('hidden');
        }

        function goToMethodStep() {
            document.getElementById('formStep').classList.add('hidden');
            document.getElementById('carrierStep').classList.add('hidden');
            document.getElementById('methodStep').classList.remove('hidden');
        }

        function goBackToMethodStep() {
            document.getElementById('carrierStep').classList.add('hidden');
            document.getElementById('methodStep').classList.remove('hidden');
            selectedCarrier = null;
        }

        function goBackFromForm() {
            if (withdrawalData.method === 'momo') {
                // Go back to carrier selection
                document.getElementById('formStep').classList.add('hidden');
                document.getElementById('carrierStep').classList.remove('hidden');
                selectedCarrier = null;
            } else {
                // Go back to method selection
                document.getElementById('formStep').classList.add('hidden');
                document.getElementById('methodStep').classList.remove('hidden');
            }
        }

        function goBack() {
            if (confirm('Are you sure? Your progress will be lost.')) {
                window.location.href = 'index.html';
            }
        }

        // Security Logging
        function logSecurityEvent(event, data) {
            const log = {
                event,
                timestamp: new Date().toISOString(),
                user: JSON.parse(localStorage.getItem('user') || '{}').email,
                data
            };
            console.log('üîí SECURITY LOG:', log);
            
            // TODO: Send to backend for persistent logging
            const logs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
            logs.push(log);
            localStorage.setItem('securityLogs', JSON.stringify(logs.slice(-50))); // Keep last 50
        }

            // Debug function (for developers/admins)
        window.showAuthKeyStatus = function() {
            const deviceId = getDeviceId();
            const usedKeys = getUsedKeysOnDevice();
            
            console.log('='.repeat(60));
            console.log('üîê AUTH KEY STATUS FOR THIS DEVICE');
            console.log('='.repeat(60));
            console.log('üì± Device ID:', deviceId);
            console.log('üìä Total Keys Used:', usedKeys.length);
            console.log('');
            
            if (usedKeys.length === 0) {
                console.log('‚ú® No auth keys have been used on this device yet');
            } else {
                usedKeys.forEach((key, index) => {
                    console.log(`Key ${index + 1}: ${key.authKey}`);
                    console.log(`  Tier: ${key.tier}`);
                    console.log(`  Uses: ${key.totalUses}/${key.maxUses}`);
                    console.log(`  Withdrawn: $${key.totalWithdrawn.toLocaleString()}/$${key.totalLimit.toLocaleString()}`);
                    console.log(`  Status: ${key.isExhausted ? '‚ùå EXHAUSTED' : '‚úÖ ACTIVE'}`);
                    console.log('');
                });
            }
            
            console.log('='.repeat(60));
            console.log('üí° To reset a specific key: resetAuthKey("KEY-CODE")');
            console.log('üí° To reset all keys: resetAllAuthKeys()');
            console.log('='.repeat(60));
        };

        // Reset specific auth key on this device
        window.resetAuthKey = function(authKey) {
            const deviceId = getDeviceId();
            const lockKey = deviceId + '_' + authKey;
            const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
            
            if (lockData[lockKey]) {
                delete lockData[lockKey];
                localStorage.setItem('authKeyLocks', JSON.stringify(lockData));
                console.log('‚úÖ Auth key reset:', authKey);
            } else {
                console.log('‚ö†Ô∏è Auth key not found on this device:', authKey);
            }
        };

        // Reset all auth keys on this device
        window.resetAllAuthKeys = function() {
            if (confirm('‚ö†Ô∏è Reset ALL auth keys on this device?\n\nThis will allow you to reuse all keys again.')) {
                const deviceId = getDeviceId();
                const lockData = JSON.parse(localStorage.getItem('authKeyLocks') || '{}');
                
                let resetCount = 0;
                for (const lockKey in lockData) {
                    if (lockKey.startsWith(deviceId + '_')) {
                        delete lockData[lockKey];
                        resetCount++;
                    }
                }
                
                localStorage.setItem('authKeyLocks', JSON.stringify(lockData));
                console.log('‚úÖ Reset ' + resetCount + ' auth keys on this device');
                cvSuccess('All authorization keys have been reset on this device.', 'Keys Reset');
            }
        };

        // Show device ID
        window.showDeviceId = function() {
            const deviceId = getDeviceId();
            console.log('üì± Your Device ID:', deviceId);
            cvShowError('Device ID: ' + deviceId + ' ‚Äî This ID is unique to this browser/device.', 'Device Info', "cv-withdraw-error");
        };
    </script>

<script>
// ===== INLINE ERROR BANNER SYSTEM =====
var _cvErrorTarget = null; // set per-form context

function cvShowError(message, title, containerId) {
    var bannerId = containerId || 'cv-form-error';
    var banner = document.getElementById(bannerId);
    if (!banner) {
        // Create and prepend to nearest form if no dedicated container
        banner = document.createElement('div');
        banner.id = bannerId;
        banner.className = 'cv-inline-error';
        banner.innerHTML =
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>' +
            '<div class="cv-inline-error-body"><div class="cv-inline-error-title" id="' + bannerId + '-title"></div><div class="cv-inline-error-msg" id="' + bannerId + '-msg"></div></div>' +
            '<button class="cv-inline-error-close" onclick="cvHideError(\'' + bannerId + '\')">&times;</button>';
        var form = document.querySelector('form') || document.querySelector('.bg-gray-800') || document.body;
        form.insertBefore(banner, form.firstChild);
    }
    var titleEl = banner.querySelector('.cv-inline-error-title') || document.getElementById(bannerId + '-title');
    var msgEl   = banner.querySelector('.cv-inline-error-msg')   || document.getElementById(bannerId + '-msg');
    if (titleEl) titleEl.textContent = title || 'Error';
    if (msgEl)   msgEl.textContent   = message;
    banner.classList.add('visible');
    banner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function cvHideError(containerId) {
    var bannerId = containerId || 'cv-form-error';
    var banner = document.getElementById(bannerId);
    if (banner) banner.classList.remove('visible');
}

// Convenience aliases matching what pages call
function cvError(msg, title)   { cvShowError(msg, title || 'Error', 'cv-withdraw-error'); }
function cvWarning(msg, title) { cvShowError(msg, title || 'Warning', 'cv-withdraw-error'); }
function cvInfo(msg, title)    { cvShowError(msg, title || 'Notice', 'cv-withdraw-error'); }
</script>
</body>
</html>