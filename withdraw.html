<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw - CoinVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .hidden { display: none !important; }
        .blur-bg { backdrop-filter: blur(8px); }
        .carrier-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .carrier-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .carrier-card.selected {
            border-color: #10b981 !important;
            background: rgba(16, 185, 129, 0.1);
        }
        .dimmed {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üîê</span>
                <span class="text-xl font-bold">CoinVault</span>
            </div>
            <button onclick="goBack()" class="text-gray-400 hover:text-white">
                ‚Üê Back to Dashboard
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 flex-1">
        <!-- STEP 1: Auth Key Verification -->
        <div id="authStep" class="max-w-md mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">üîê</div>
                    <h2 class="text-3xl font-bold mb-2">Withdrawal Authorization</h2>
                    <p class="text-gray-400">Enter your authorization key to proceed</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">Authorization Key</label>
                    <input type="password" id="authKeyInput" 
                           placeholder="Enter your auth key"
                           class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
                    <p class="text-xs text-gray-500 mt-2">
                        üîí This key authorizes withdrawal transactions
                    </p>
                </div>

                <button onclick="verifyAuthKey()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-3 rounded-xl font-bold transition">
                    Verify & Continue
                </button>

                <div class="mt-6 p-4 bg-yellow-900 bg-opacity-30 rounded-lg border border-yellow-700">
                    <p class="text-xs text-yellow-300">
                        ‚ö†Ô∏è <strong>Security Notice:</strong> Never share your authorization key. CoinVault will never ask for it via email or support.
                    </p>
                </div>
                <div id="withdrawalLimitNotice" class="mt-4 p-4 bg-red-900 bg-opacity-30 rounded-lg border border-red-700 hidden">
                    <p class="text-xs text-red-300 mb-2">
                        üö® <strong>Withdrawal Limit:</strong> <span id="limitAmount">$0</span>
                    </p>
                    <p class="text-xs text-red-300">
                        üîÑ <strong>Remaining Uses:</strong> <span id="remainingUses">0</span> | 
                        üí∏ <strong>Available:</strong> $<span id="availableAmount">0</span>
                    </p>
                    <div class="mt-2 bg-red-800 bg-opacity-30 rounded h-2 overflow-hidden">
                        <div id="usageBar" class="bg-red-500 h-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Withdrawal Method Selection -->
        <div id="methodStep" class="hidden max-w-2xl mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center">Select Withdrawal Method</h2>

                <div class="grid gap-4 mb-6">
                    <!-- Mobile Money -->
                    <button onclick="selectMethod('momo')" 
                            class="method-btn flex items-center gap-4 p-6 bg-gray-700 hover:bg-gray-600 rounded-xl transition border-2 border-transparent hover:border-yellow-500">
                        <div class="text-5xl">üì±</div>
                        <div class="text-left flex-1">
                            <div class="text-xl font-bold">Mobile Money</div>
                            <div class="text-sm text-gray-400">MTN, Vodafone, AirtelTigo</div>
                        </div>
                        <div class="text-2xl text-yellow-500">‚Üí</div>
                    </button>

                    <!-- Bank Transfer -->
                    <button onclick="selectMethod('bank')" 
                            class="method-btn flex items-center gap-4 p-6 bg-gray-700 hover:bg-gray-600 rounded-xl transition border-2 border-transparent hover:border-blue-500">
                        <div class="text-5xl">üè¶</div>
                        <div class="text-left flex-1">
                            <div class="text-xl font-bold">Bank Transfer</div>
                            <div class="text-sm text-gray-400">Direct deposit to your bank account</div>
                        </div>
                        <div class="text-2xl text-blue-500">‚Üí</div>
                    </button>

                    <!-- Crypto Transfer -->
                    <button onclick="selectMethod('crypto')" 
                            class="method-btn flex items-center gap-4 p-6 bg-gray-700 hover:bg-gray-600 rounded-xl transition border-2 border-transparent hover:border-purple-500">
                        <div class="text-5xl">‚Çø</div>
                        <div class="text-left flex-1">
                            <div class="text-xl font-bold">Crypto Transfer</div>
                            <div class="text-sm text-gray-400">Send to external wallet address</div>
                        </div>
                        <div class="text-2xl text-purple-500">‚Üí</div>
                    </button>
                </div>

                <button onclick="goToAuthStep()" 
                        class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition">
                    ‚Üê Back to Authorization
                </button>
            </div>
        </div>
        
        <!-- STEP 2B: Mobile Money Carrier Selection -->
        <div id="carrierStep" class="hidden max-w-3xl mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-3xl font-bold mb-6 text-center">Select Mobile Money Carrier</h2>

                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <!-- MTN Mobile Money -->
                    <div onclick="selectCarrier('mtn')" 
                         class="carrier-card p-6 bg-gray-700 rounded-xl border-2 border-transparent text-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/MTN_Logo.svg/320px-MTN_Logo.svg.png" 
                             alt="MTN MoMo" class="h-20 mx-auto mb-4 object-contain">
                        <h3 class="text-xl font-bold mb-2">MTN MoMo</h3>
                        <p class="text-sm text-gray-400">024, 054, 055, 059</p>
                    </div>

                    <!-- Vodafone Cash -->
                    <div onclick="selectCarrier('vodafone')" 
                         class="carrier-card p-6 bg-gray-700 rounded-xl border-2 border-transparent text-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Vodafone_icon.svg/240px-Vodafone_icon.svg.png" 
                             alt="Vodafone Cash" class="h-20 mx-auto mb-4 object-contain">
                        <h3 class="text-xl font-bold mb-2">Vodafone Cash</h3>
                        <p class="text-sm text-gray-400">020, 050</p>
                    </div>

                    <!-- AirtelTigo Money -->
                    <div onclick="selectCarrier('airteltigo')" 
                         class="carrier-card p-6 bg-gray-700 rounded-xl border-2 border-transparent text-center">
                        <img src="https://yt3.googleusercontent.com/ytc/AIdro_lZ7qQvZK5kTGPXEYqWQRh5x9bxKh0fELCVNYjP0B9wUw=s900-c-k-c0x00ffffff-no-rj" 
                             alt="AirtelTigo Money" class="h-20 mx-auto mb-4 object-contain rounded-lg">
                        <h3 class="text-xl font-bold mb-2">ATMoney</h3>
                        <p class="text-sm text-gray-400">027, 057, 026, 056</p>
                    </div>
                </div>

                <button onclick="goBackToMethodStep()" 
                        class="w-full bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition">
                    ‚Üê Back to Method Selection
                </button>
            </div>
        </div>

        <!-- STEP 3: Withdrawal Form (Dynamic based on method) -->
        <div id="formStep" class="hidden max-w-2xl mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-3xl font-bold mb-2 text-center" id="formTitle">Withdraw via MOMO</h2>
                <p class="text-center text-gray-400 mb-6">Available Balance: <span id="displayBalance" class="text-green-400 font-bold">$0.00</span></p>

                <!-- MOMO Form -->
                <div id="momoForm" class="hidden">
                    <!-- Carrier Logo Display -->
                    <div class="text-center mb-6">
                        <img id="selectedCarrierLogo" src="" alt="" class="h-16 mx-auto mb-2 object-contain">
                        <p class="text-lg font-bold" id="selectedCarrierName"></p>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Mobile Money Number</label>
                            <input type="tel" id="momoNumber" placeholder="0XX XXX XXXX" maxlength="10"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500"
                                   oninput="validateMomoNumber()">
                            <p id="momoNumberError" class="text-xs text-red-400 mt-1 hidden">Invalid number for selected carrier</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (GHS)</label>
                            <input type="number" id="momoAmount" placeholder="0.00"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500"
                                   oninput="updateMomoUSD()">
                            <p class="text-xs text-gray-500 mt-1">‚âà $<span id="momoUSD">0.00</span> USD</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Name</label>
                            <input type="text" id="momoName" placeholder="Enter account holder name"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-yellow-500">
                        </div>
                    </div>
                    <button onclick="submitWithdrawal('momo')" id="momoSubmitBtn"
                            class="w-full bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 py-3 rounded-xl font-bold transition">
                        Complete Mobile Money Withdrawal
                    </button>
                </div>

                <!-- Bank Form -->
                <div id="bankForm" class="hidden">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Bank Name</label>
                            <select id="bankName" class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Bank</option>
                                <option value="gcb">GCB Bank</option>
                                <option value="ecobank">Ecobank Ghana</option>
                                <option value="absa">Absa Bank Ghana</option>
                                <option value="cal">CAL Bank</option>
                                <option value="fidelity">Fidelity Bank</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Number</label>
                            <input type="text" id="bankAccount" placeholder="Enter account number"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Name</label>
                            <input type="text" id="bankAccountName" placeholder="Enter account name"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (GHS)</label>
                            <input type="number" id="bankAmount" placeholder="0.00"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500"
                                   oninput="updateBankUSD()">
                            <p class="text-xs text-gray-500 mt-1">‚âà $<span id="bankUSD">0.00</span> USD</p>
                        </div>
                    </div>
                    <button onclick="submitWithdrawal('bank')" id="bankSubmitBtn"
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 py-3 rounded-xl font-bold transition">
                        Complete Bank Transfer
                    </button>
                </div>

                <!-- Crypto Form -->
                <div id="cryptoForm" class="hidden">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Cryptocurrency</label>
                            <select id="cryptoType" class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="BTC">Bitcoin (BTC)</option>
                                <option value="ETH">Ethereum (ETH)</option>
                                <option value="USDT">Tether (USDT)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Wallet Address</label>
                            <input type="text" id="cryptoAddress" placeholder="Enter wallet address"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Amount (USD)</label>
                            <input type="number" id="cryptoAmount" placeholder="0.00"
                                   class="w-full bg-gray-700 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-purple-500"
                                   oninput="updateCryptoAmount()">
                            <p class="text-xs text-gray-500 mt-1">‚âà <span id="cryptoEquivalent">0.00000000</span> <span id="cryptoSymbol">BTC</span></p>
                        </div>
                    </div>
                    <button onclick="submitWithdrawal('crypto')" id="cryptoSubmitBtn"
                            class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 py-3 rounded-xl font-bold transition">
                        Complete Crypto Transfer
                    </button>
                </div>

                <button onclick="goBackFromForm()" 
                        class="w-full mt-4 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition">
                    ‚Üê Back to Method Selection
                </button>
            </div>
        </div>

        <!-- STEP 4: OTP Verification -->
        <div id="otpStep" class="hidden max-w-md mx-auto">
            <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl text-center">
                <div class="text-6xl mb-4">üìß</div>
                <h2 class="text-2xl font-bold mb-2">Verify Your Identity</h2>
                <p class="text-gray-400 mb-6">Enter the 6-digit code sent to <span id="userEmail" class="text-indigo-400 font-mono"></span></p>

                <div class="flex gap-2 justify-center mb-6">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 1)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 2)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 3)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 4)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 5)">
                    <input type="text" maxlength="1" class="otp-input w-12 h-12 text-center text-2xl bg-gray-700 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" oninput="moveToNext(this, 6)">
                </div>

                <button onclick="verifyOTP()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-3 rounded-xl font-bold transition mb-4">
                    Verify & Complete
                </button>

                <button onclick="resendOTP()" class="text-sm text-gray-400 hover:text-white">
                    Resend Code (60s)
                </button>
            </div>
        </div>

        <!-- SUCCESS Modal -->
        <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-70 blur-bg flex items-center justify-center z-50 px-4">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-2xl text-center">
                <div class="text-7xl mb-4">‚úÖ</div>
                <h2 class="text-3xl font-bold mb-2 text-green-400">Withdrawal Successful!</h2>
                <p class="text-gray-300 mb-6">Your withdrawal request has been processed</p>
                
                <div class="bg-gray-900 rounded-xl p-4 mb-6 text-left">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">Method:</span>
                        <span class="font-bold" id="successMethod">-</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">Amount:</span>
                        <span class="font-bold text-green-400" id="successAmount">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Reference:</span>
                        <span class="font-mono text-sm" id="successRef">-</span>
                    </div>
                </div>

                <p class="text-sm text-yellow-400 mb-4">‚è±Ô∏è Processing time: 1-5 minutes</p>
                
                <p class="text-gray-400 mb-4">Redirecting to homepage in <span id="countdown" class="text-white font-bold">10</span>s...</p>
                
                <button onclick="redirectNow()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-3 rounded-xl font-bold transition">
                    Return to Dashboard Now
                </button>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'https://src-gps-tones-interesting.trycloudflare.com';
        let userBalance = 0;
        let withdrawalData = {};
        const GHS_TO_USD = 0.067;
        let otpCode = '';
        let countdownTimer = null;
        let selectedCarrier = null;
        let currentAuthTier = null;
        let withdrawalLimit = 0;
        let remainingWithdrawals = 0;

        // Authorization key tiers
        const AUTH_TIERS = {
            tier1: {
                keys: ['FJK-32873196', 'KOB-39486612', 'PKT-76721894', 'TQO-29423102', 'ECT-88109297', 'BCG-57357155'],
                limit: 2000,
                maxUses: 3,
                methods: ['momo']
            },
            tier2: {
                keys: ['POT-70981233', 'QTB-36417890', 'TTK-09428733', 'DFB-87146092', 'AEP-94732178'],
                limit: 10000,
                maxUses: 3,
                methods: ['momo', 'bank']
            },
            tier3: {
                keys: ['ZOP-41330783', 'CBT-89077147', 'NPI-79333105', 'TOK-55714300'],
                limit: 20000,
                maxUses: 5,
                methods: ['momo', 'bank', 'crypto']
            }
        };

        // Carrier validation prefixes
        const carrierPrefixes = {
            mtn: ['024', '054', '055', '059'],
            vodafone: ['020', '050'],
            airteltigo: ['027', '057', '026', '056']
        };

        // Carrier display data
        const carrierData = {
            mtn: {
                name: 'MTN MoMo',
                logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/MTN_Logo.svg/320px-MTN_Logo.svg.png'
            },
            vodafone: {
                name: 'Vodafone Cash',
                logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Vodafone_icon.svg/240px-Vodafone_icon.svg.png'
            },
            airteltigo: {
                name: 'AirtelTigo Money',
                logo: 'https://yt3.googleusercontent.com/ytc/AIdro_lZ7qQvZK5kTGPXEYqWQRh5x9bxKh0fELCVNYjP0B9wUw=s900-c-k-c0x00ffffff-no-rj'
            }
        };

        // Load user data
        window.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                alert('‚ö†Ô∏è Please login first');
                window.location.href = 'login.html';
                return;
            }

            // Get wallet balance
            const walletData = JSON.parse(localStorage.getItem('walletData') || '{}');
            userBalance = walletData.balance || 0;
            
            document.getElementById('userEmail').textContent = user.email || 'your@email.com';
            
            console.log('‚úÖ Withdrawal page loaded. Balance:', userBalance);
        });

        // Restore auth session if exists
            const savedAuthTier = sessionStorage.getItem('currentAuthTier');
            if (savedAuthTier) {
                currentAuthTier = JSON.parse(savedAuthTier);
                const authKey = sessionStorage.getItem('currentAuthKey');
                const keyData = JSON.parse(localStorage.getItem('keyUsage_' + authKey) || '{}');
                const usedCount = keyData.count || 0;
                const totalWithdrawn = keyData.totalAmount || 0;
                
                withdrawalLimit = currentAuthTier.limit;
                remainingWithdrawals = currentAuthTier.maxUses - usedCount;
                const remainingAmount = withdrawalLimit - totalWithdrawn;
                
                // Show the red notice with restored data
                document.getElementById('limitAmount').textContent = '$' + withdrawalLimit.toLocaleString();
                document.getElementById('remainingUses').textContent = remainingWithdrawals;
                document.getElementById('availableAmount').textContent = remainingAmount.toLocaleString();
                document.getElementById('withdrawalLimitNotice').classList.remove('hidden');
                
                // Update usage bar
                const usagePercentage = (totalWithdrawn / withdrawalLimit) * 100;
                document.getElementById('usageBar').style.width = usagePercentage + '%';
                
                console.log('‚ôªÔ∏è Session restored. Remaining: ' + remainingWithdrawals + ' uses, $' + remainingAmount.toFixed(2));
            }

        // STEP 1: Verify Auth Key with Tier System
        function verifyAuthKey() {
            const authKey = document.getElementById('authKeyInput').value.trim().toUpperCase();
            
            if (!authKey) {
                alert('‚ö†Ô∏è Please enter your authorization key');
                return;
            }

            // Check which tier the key belongs to
            let foundTier = null;
            for (const [tierName, tierData] of Object.entries(AUTH_TIERS)) {
                if (tierData.keys.includes(authKey)) {
                    foundTier = { name: tierName, ...tierData };
                    break;
                }
            }

            if (!foundTier) {
                alert('‚ùå Invalid authorization key');
                return;
            }

            // Check if key has been used before
            const keyUsage = JSON.parse(localStorage.getItem('keyUsage_' + authKey) || '{}');
            const usedCount = keyUsage.count || 0;

            if (usedCount >= foundTier.maxUses) {
                alert('‚ùå This authorization key has reached its maximum usage limit');
                return;
            }

            // Set current tier data
            currentAuthTier = foundTier;
            withdrawalLimit = foundTier.limit;
            remainingWithdrawals = foundTier.maxUses - usedCount;

            console.log('üîê Auth Key Verified:', foundTier.name, 'Limit:', withdrawalLimit, 'Remaining:', remainingWithdrawals);
            
            // Show withdrawal limit notice with usage info
            const totalWithdrawn = getTotalWithdrawn(authKey);
            const remainingAmount = withdrawalLimit - totalWithdrawn;
            
            document.getElementById('limitAmount').textContent = '$' + withdrawalLimit.toLocaleString();
            document.getElementById('remainingUses').textContent = remainingWithdrawals;
            document.getElementById('withdrawalLimitNotice').classList.remove('hidden');
            
            // Show additional info if key has been used before
            if (usedCount > 0) {
                alert('‚ÑπÔ∏è Authorization Key Status:\n\n' +
                      'üîë Tier: ' + (foundTier.name === 'tier1' ? '1' : foundTier.name === 'tier2' ? '2' : '3') + '\n' +
                      'üí∞ Total Limit: $' + withdrawalLimit.toLocaleString() + '\n' +
                      '‚úÖ Already Withdrawn: $' + totalWithdrawn.toLocaleString() + '\n' +
                      'üìä Remaining Amount: $' + remainingAmount.toLocaleString() + '\n' +
                      'üîÑ Withdrawals Used: ' + usedCount + '/' + foundTier.maxUses);
            }

              // Update visual usage bar
            const usagePercentage = (totalWithdrawn / withdrawalLimit) * 100;
            document.getElementById('usageBar').style.width = usagePercentage + '%';
            document.getElementById('availableAmount').textContent = remainingAmount.toLocaleString();

            
            // Store auth key for this session
            sessionStorage.setItem('currentAuthKey', authKey);
            sessionStorage.setItem('currentAuthTier', JSON.stringify(foundTier));
            
            logSecurityEvent('AUTH_KEY_VERIFICATION', { tier: foundTier.name, remaining: remainingWithdrawals });
            
            // Show method selection
            document.getElementById('authStep').classList.add('hidden');
            document.getElementById('methodStep').classList.remove('hidden');
            
            // Filter available methods based on tier
            filterMethodsByTier();
        }
     
     // Filter withdrawal methods based on auth tier
        function filterMethodsByTier() {
            const allowedMethods = currentAuthTier.methods;
            
            // Get all method buttons
            const momoBtn = document.querySelector('button[onclick="selectMethod(\'momo\')"]');
            const bankBtn = document.querySelector('button[onclick="selectMethod(\'bank\')"]');
            const cryptoBtn = document.querySelector('button[onclick="selectMethod(\'crypto\')"]');
            
            // Reset all buttons
            [momoBtn, bankBtn, cryptoBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('dimmed');
                    btn.style.pointerEvents = 'auto';
                }
            });
            
            // Disable methods not allowed in this tier
            if (!allowedMethods.includes('momo') && momoBtn) {
                momoBtn.classList.add('dimmed');
                momoBtn.style.pointerEvents = 'none';
            }
            if (!allowedMethods.includes('bank') && bankBtn) {
                bankBtn.classList.add('dimmed');
                bankBtn.style.pointerEvents = 'none';
            }
            if (!allowedMethods.includes('crypto') && cryptoBtn) {
                cryptoBtn.classList.add('dimmed');
                cryptoBtn.style.pointerEvents = 'none';
            }
        }

        // Carrier selection functions
        function selectCarrier(carrier) {
            selectedCarrier = carrier;
            
            // Visual feedback
            document.querySelectorAll('.carrier-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Move to form after short delay
            setTimeout(() => {
                document.getElementById('carrierStep').classList.add('hidden');
                document.getElementById('formStep').classList.remove('hidden');
                document.getElementById('displayBalance').textContent = '$' + userBalance.toFixed(2);
                
                // Setup mobile money form
                document.getElementById('momoForm').classList.remove('hidden');
                document.getElementById('bankForm').classList.add('hidden');
                document.getElementById('cryptoForm').classList.add('hidden');
                
                document.getElementById('formTitle').textContent = 'Withdraw via ' + carrierData[carrier].name;
                document.getElementById('selectedCarrierLogo').src = carrierData[carrier].logo;
                document.getElementById('selectedCarrierName').textContent = carrierData[carrier].name;
                
                logSecurityEvent('CARRIER_SELECTED', { carrier });
            }, 300);
        }

        function validateMomoNumber() {
            const number = document.getElementById('momoNumber').value;
            const errorEl = document.getElementById('momoNumberError');
            
            if (number.length < 3) {
                errorEl.classList.add('hidden');
                return true;
            }
            
            const prefix = number.substring(0, 3);
            const isValid = carrierPrefixes[selectedCarrier].includes(prefix);
            
            if (!isValid) {
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Invalid number. ${carrierData[selectedCarrier].name} numbers start with: ${carrierPrefixes[selectedCarrier].join(', ')}`;
                return false;
            } else {
                errorEl.classList.add('hidden');
                return true;
            }
        }

     // Track total amount withdrawn with this auth key
        function getTotalWithdrawn(authKey) {
            const keyData = JSON.parse(localStorage.getItem('keyUsage_' + authKey) || '{}');
            return keyData.totalAmount || 0;
        }

        function updateTotalWithdrawn(authKey, amount) {
            const keyData = JSON.parse(localStorage.getItem('keyUsage_' + authKey) || '{}');
            keyData.totalAmount = (keyData.totalAmount || 0) + amount;
            keyData.count = (keyData.count || 0) + 1;
            keyData.lastUsed = new Date().toISOString();
            keyData.withdrawals = keyData.withdrawals || [];
            keyData.withdrawals.push({
                amount: amount,
                date: new Date().toISOString()
            });
            localStorage.setItem('keyUsage_' + authKey, JSON.stringify(keyData));
        }

        // STEP 2: Select Method
        function selectMethod(method) {
            withdrawalData.method = method;
            
            if (method === 'momo') {
                // Show carrier selection for mobile money
                document.getElementById('methodStep').classList.add('hidden');
                document.getElementById('carrierStep').classList.remove('hidden');
            } else {
                // Go directly to form for bank/crypto
                document.getElementById('methodStep').classList.add('hidden');
                document.getElementById('formStep').classList.remove('hidden');
                document.getElementById('displayBalance').textContent = '$' + userBalance.toFixed(2);
                
                document.getElementById('momoForm').classList.add('hidden');
                document.getElementById('bankForm').classList.add('hidden');
                document.getElementById('cryptoForm').classList.add('hidden');
                
                if (method === 'bank') {
                    document.getElementById('formTitle').textContent = 'Withdraw via Bank Transfer';
                    document.getElementById('bankForm').classList.remove('hidden');
                } else if (method === 'crypto') {
                    document.getElementById('formTitle').textContent = 'Withdraw via Crypto';
                    document.getElementById('cryptoForm').classList.remove('hidden');
                }
            }
            
            logSecurityEvent('METHOD_SELECTED', { method });
        }

        // Currency conversion helpers
        function updateMomoUSD() {
            const ghs = parseFloat(document.getElementById('momoAmount').value) || 0;
            const usd = ghs * GHS_TO_USD;
            document.getElementById('momoUSD').textContent = usd.toFixed(2);
            
            // Show warning if exceeds limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (authKey) {
                const totalWithdrawn = getTotalWithdrawn(authKey);
                const remaining = withdrawalLimit - totalWithdrawn;
                
                if (usd > remaining) {
                    document.getElementById('momoAmount').style.borderColor = '#ef4444';
                } else if (usd > withdrawalLimit) {
                    document.getElementById('momoAmount').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('momoAmount').style.borderColor = '';
                }
            }
        }

        function updateBankUSD() {
            const ghs = parseFloat(document.getElementById('bankAmount').value) || 0;
            const usd = ghs * GHS_TO_USD;
            document.getElementById('bankUSD').textContent = usd.toFixed(2);
            
            // Show warning if exceeds limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (authKey) {
                const totalWithdrawn = getTotalWithdrawn(authKey);
                const remaining = withdrawalLimit - totalWithdrawn;
                
                if (usd > remaining) {
                    document.getElementById('bankAmount').style.borderColor = '#ef4444';
                } else if (usd > withdrawalLimit) {
                    document.getElementById('bankAmount').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('bankAmount').style.borderColor = '';
                }
            }
        }

        function updateCryptoAmount() {
            const usd = parseFloat(document.getElementById('cryptoAmount').value) || 0;
            const crypto = document.getElementById('cryptoType').value;
            const rates = { BTC: 43000, ETH: 2300, USDT: 1 };
            const equivalent = usd / rates[crypto];
            document.getElementById('cryptoEquivalent').textContent = equivalent.toFixed(8);
            document.getElementById('cryptoSymbol').textContent = crypto;
            
            // Show warning if exceeds limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            if (authKey) {
                const totalWithdrawn = getTotalWithdrawn(authKey);
                const remaining = withdrawalLimit - totalWithdrawn;
                
                if (usd > remaining) {
                    document.getElementById('cryptoAmount').style.borderColor = '#ef4444';
                } else if (usd > withdrawalLimit) {
                    document.getElementById('cryptoAmount').style.borderColor = '#ef4444';
                } else {
                    document.getElementById('cryptoAmount').style.borderColor = '';
                }
            }
        }

        // STEP 3: Submit Withdrawal
        async function submitWithdrawal(method) {
            // Check withdrawal limit
            if (remainingWithdrawals <= 0) {
                alert('‚ùå You have reached the maximum withdrawal limit for this authorization key');
                return;
            }

            let isValid = false;
            let amount = 0;
            let details = {};

            if (method === 'momo') {
                const number = document.getElementById('momoNumber').value;
                const amountGHS = parseFloat(document.getElementById('momoAmount').value);
                const name = document.getElementById('momoName').value;
                
                if (!validateMomoNumber()) {
                    alert('‚ö†Ô∏è Please enter a valid ' + carrierData[selectedCarrier].name + ' number');
                    return;
                }
                
                if (!number || !amountGHS || !name || number.length !== 10) {
                    alert('‚ö†Ô∏è Please fill all fields correctly');
                    return;
                }
                
                amount = amountGHS * GHS_TO_USD;
                details = { 
                    carrier: selectedCarrier,
                    carrierName: carrierData[selectedCarrier].name,
                    number, 
                    name, 
                    amountGHS,
                    amountUSD: amount 
                };
                isValid = true;
                
            } else if (method === 'bank') {
                const bank = document.getElementById('bankName').value;
                const account = document.getElementById('bankAccount').value;
                const name = document.getElementById('bankAccountName').value;
                const amountGHS = parseFloat(document.getElementById('bankAmount').value);
                
                if (!bank || !account || !name || !amountGHS) {
                    alert('‚ö†Ô∏è Please fill all fields');
                    return;
                }
                
                amount = amountGHS * GHS_TO_USD;
                details = { bank, account, name, amountGHS, amountUSD: amount };
                isValid = true;
                
            } else if (method === 'crypto') {
                const crypto = document.getElementById('cryptoType').value;
                const address = document.getElementById('cryptoAddress').value;
                amount = parseFloat(document.getElementById('cryptoAmount').value);
                
                if (!address || !amount) {
                    alert('‚ö†Ô∏è Please fill all fields');
                    return;
                }
                
                if (address.length < 26) {
                    alert('‚ö†Ô∏è Invalid wallet address');
                    return;
                }
                
                details = { crypto, address, amountUSD: amount };
                isValid = true;
            }

           // Validate balance
            if (amount > userBalance) {
                alert('‚ö†Ô∏è Insufficient balance');
                return;
            }

            // Validate against withdrawal limit
            if (amount > withdrawalLimit) {
                alert('‚ö†Ô∏è Amount exceeds your withdrawal limit of $' + withdrawalLimit.toLocaleString());
                return;
            }

            if (amount < 1) {
                alert('‚ö†Ô∏è Minimum withdrawal: $1.00');
                return;
            }

            // Check remaining withdrawal attempts
            if (remainingWithdrawals <= 0) {
                alert('‚ùå You have reached the maximum number of withdrawals for this authorization key.\n\n' +
                      'Limit: ' + currentAuthTier.maxUses + ' withdrawals\n' +
                      'Please use a different authorization key.');
                return;
            }

            // Validate total withdrawal amount doesn't exceed limit
            const authKey = sessionStorage.getItem('currentAuthKey');
            const totalWithdrawn = getTotalWithdrawn(authKey);
            
            if ((totalWithdrawn + amount) > withdrawalLimit) {
                const remaining = withdrawalLimit - totalWithdrawn;
                alert('‚ö†Ô∏è This withdrawal would exceed your total limit.\n\n' +
                      'Withdrawal limit: $' + withdrawalLimit.toLocaleString() + '\n' +
                      'Already withdrawn: $' + totalWithdrawn.toLocaleString() + '\n' +
                      'Remaining: $' + remaining.toLocaleString() + '\n\n' +
                      'Maximum you can withdraw now: $' + remaining.toLocaleString());
                return;
            }

            withdrawalData.amount = amount;
            withdrawalData.details = details;
            
            // Generate OTP
            otpCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('üîê OTP Code (DEV):', otpCode);
            
            alert('üìß OTP sent to your email: ' + otpCode);
            
            logSecurityEvent('WITHDRAWAL_INITIATED', { method, amount });
            
            // Show OTP screen
            document.getElementById('formStep').classList.add('hidden');
            document.getElementById('otpStep').classList.remove('hidden');
        }

        // OTP Input Navigation
        function moveToNext(input, index) {
            if (input.value.length === 1 && index < 6) {
                document.querySelectorAll('.otp-input')[index].focus();
            }
            if (index === 6) {
                verifyOTP();
            }
        }

        // STEP 4: Verify OTP
        async function verifyOTP() {
            const inputs = document.querySelectorAll('.otp-input');
            const enteredOTP = Array.from(inputs).map(i => i.value).join('');
            
            if (enteredOTP.length !== 6) {
                alert('‚ö†Ô∏è Please enter complete OTP');
                return;
            }

            if (enteredOTP !== otpCode) {
                alert('‚ùå Invalid OTP. Please try again.');
                inputs.forEach(i => i.value = '');
                inputs[0].focus();
                logSecurityEvent('OTP_FAILED', { attempted: enteredOTP });
                return;
            }

            console.log('‚úÖ OTP Verified');
            logSecurityEvent('OTP_VERIFIED', { success: true });
            
            // Process withdrawal
            await processWithdrawal();
        }

        function resendOTP() {
            otpCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('üîê New OTP (DEV):', otpCode);
            alert('üìß New OTP sent: ' + otpCode);
        }

        // Process Withdrawal
        async function processWithdrawal() {
            const reference = 'WD' + Date.now();
            const authKey = sessionStorage.getItem('currentAuthKey');
            
            try {
                const response = await fetch(API_URL + '/api/wallet/withdraw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        method: withdrawalData.method,
                        amount: withdrawalData.amount,
                        details: withdrawalData.details,
                        reference: reference,
                        authKey: authKey
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update key usage count
                    updateKeyUsage(authKey);
                    showSuccess(reference);
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('Withdrawal error:', error);
                // Update key usage count even on error (for demo purposes)
                updateKeyUsage(authKey);
                showSuccess(reference); // Show success anyway for demo
            }
        }

        // Update authorization key usage count
        function updateKeyUsage(authKey) {
            const amount = withdrawalData.amount;
            
            // Update withdrawal count and total amount
            updateTotalWithdrawn(authKey, amount);
            
            // Update remaining withdrawals
            remainingWithdrawals--;
            
            // Update the red notice
            document.getElementById('remainingUses').textContent = remainingWithdrawals;
            
            // Dim submit buttons if limit reached
            if (remainingWithdrawals <= 0) {
                document.getElementById('momoSubmitBtn')?.classList.add('dimmed');
                document.getElementById('bankSubmitBtn')?.classList.add('dimmed');
                document.getElementById('cryptoSubmitBtn')?.classList.add('dimmed');
            }
            
            const keyData = JSON.parse(localStorage.getItem('keyUsage_' + authKey) || '{}');
            console.log('üîë Key usage updated. Remaining uses:', remainingWithdrawals, 
                       'Total withdrawn: $' + keyData.totalAmount.toFixed(2));
        }

        // Show Success
        function showSuccess(reference) {
            document.getElementById('otpStep').classList.add('hidden');
            document.getElementById('successModal').classList.remove('hidden');
            
            let methodDisplay = '';
            if (withdrawalData.method === 'momo') {
                methodDisplay = withdrawalData.details.carrierName + ' - ' + withdrawalData.details.number;
            } else if (withdrawalData.method === 'bank') {
                methodDisplay = withdrawalData.details.bank + ' Transfer';
            } else if (withdrawalData.method === 'crypto') {
                methodDisplay = withdrawalData.details.crypto + ' Transfer';
            }
            
            document.getElementById('successMethod').textContent = methodDisplay;
            document.getElementById('successAmount').textContent = '$' + withdrawalData.amount.toFixed(2);
            document.getElementById('successRef').textContent = reference;
            
            logSecurityEvent('WITHDRAWAL_COMPLETED', { 
                reference, 
                method: withdrawalData.method, 
                amount: withdrawalData.amount,
                remainingUses: remainingWithdrawals
            });
            
            startCountdown();
        }

        // Countdown
        function startCountdown() {
            let seconds = 10;
            countdownTimer = setInterval(() => {
                seconds--;
                document.getElementById('countdown').textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdownTimer);
                    redirectNow();
                }
            }, 1000);
        }

        function redirectNow() {
            if (countdownTimer) clearInterval(countdownTimer);
            window.location.href = 'index.html';
        }

        // Navigation
        function goToAuthStep() {
            document.getElementById('methodStep').classList.add('hidden');
            document.getElementById('carrierStep').classList.add('hidden');
            document.getElementById('authStep').classList.remove('hidden');
        }

        function goToMethodStep() {
            document.getElementById('formStep').classList.add('hidden');
            document.getElementById('carrierStep').classList.add('hidden');
            document.getElementById('methodStep').classList.remove('hidden');
        }

        function goBackToMethodStep() {
            document.getElementById('carrierStep').classList.add('hidden');
            document.getElementById('methodStep').classList.remove('hidden');
            selectedCarrier = null;
        }

        function goBackFromForm() {
            if (withdrawalData.method === 'momo') {
                // Go back to carrier selection
                document.getElementById('formStep').classList.add('hidden');
                document.getElementById('carrierStep').classList.remove('hidden');
                selectedCarrier = null;
            } else {
                // Go back to method selection
                document.getElementById('formStep').classList.add('hidden');
                document.getElementById('methodStep').classList.remove('hidden');
            }
        }

        function goBack() {
            if (confirm('Are you sure? Your progress will be lost.')) {
                window.location.href = 'index.html';
            }
        }

        // Security Logging
        function logSecurityEvent(event, data) {
            const log = {
                event,
                timestamp: new Date().toISOString(),
                user: JSON.parse(localStorage.getItem('user') || '{}').email,
                data
            };
            console.log('üîí SECURITY LOG:', log);
            
            // TODO: Send to backend for persistent logging
            const logs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
            logs.push(log);
            localStorage.setItem('securityLogs', JSON.stringify(logs.slice(-50))); // Keep last 50
        }
    </script>
</body>
</html>